<!DOCTYPE HTML>
<html>
<head>
    <title>OtD: 텍스트 분석</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.6.0/Chart.bundle.min.js"></script>
    <style>
body {margin:0;}

.navbar {
  overflow: hidden;
  background-color: #333;
  position: fixed;
  top: 0;
  width: 100%;
}

.navbar a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}

#searchParam{
    padding-top: 50px;
}

.main {
  padding: 16px;
  margin-top: 30px;
}

html, body, #container {
    width: 100%;
    height: 100%;
    margin: 0;
}

#common_nouns {
    width: 100%;
    height: 100%;
}
</style>
</head>
<body onload="dateSetter()">
<div class="navbar">
    <a href="/">Home</a>
    <a href="/trending.html">Trending Words</a>
    <a href="/text_analysis.html">Text Analysis</a>
    <a href="/contact.html">Contact</a>
    <a href="/about.html">About</a>
</div>

<div class="main">
    <form id="searchParam" onsubmit="return getTextAnalysis();">
        <select name="gameName" id="gameName">
            <option value="리니지m">리니지m</option>
            <option value="소녀전선">소녀전선</option>
        </select><br />
        기간: <input type="date" name="startDate" id="startDate" value="2017-08-20" min="2017-08-20" max="2000-13-13"/> 부터 <input type="date" name="endDate" id="endDate" value="2017-08-20" min="2000-01-02" max="2000-13-13"/>까지<br />
        <Input type="submit" value="Submit" />
    </form>

    <div id="container">
        <canvas id = "common_nouns"></canvas>
    </div>

    <script>//<![CDATA[
        // get Text analysis data from DB
        function getTextAnalysis()
        {
            var params = {
                gameName : '"' + document.getElementById("searchParam").elements[0].value + '"',
                startDate : document.getElementById("searchParam").elements[1].value,
                endDate : document.getElementById("searchParam").elements[2].value
            }
            var url = "get_text_analysis" + formatParams(params);
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function() {
                if (this.readyState == 4 && this.status == 200) {
                    document.getElementById("container").innerHTML = '&nbsp;';
                    document.getElementById("container").innerHTML = '<canvas id = "common_nouns"></canvas>';
                    formatDataForChart(this.responseText);
                }
            };
            xhttp.open("GET", url, true);
            xhttp.send();
            return false;
        }

        function formatDataForChart(data)
        {
            var jsonData = JSON.parse(data);
            var chartData = [];
            var noun = [];
            var count = [];
            for (var key in jsonData)
            {
                if (jsonData.hasOwnProperty(key))
                {
                    noun.push(key);
                    count.push(jsonData[key]);
                }
            }
            chartData.push(noun);
            chartData.push(count);

            drawChart(chartData);
        }

        function drawChart(data)
        {
            var title = "가장 많이 언급된 명사 (Nouns that were most commonly mentioned)."

            var ctx = document.getElementById("common_nouns").getContext('2d');
            ctx.canvas.width = window.innerWidth;
            ctx.canvas.height = window.innerHeight - 200;

            var chart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data[0],
                datasets: [{
                    label: '횟수(Count)',
                    data: data[1]
                    }]
            },
            options: {
                title: {
                    display: true,
                    text: title
                },
                scales: {
                    yAxes: [{
                        ticks: {
                            beginAtZero:true
                        }
                    }]
                }
            }
        });
        }

        //format date and set maximum for the two date fields
        function dateSetter()
        {
            var today = new Date();
            var dd = today.getDate();
            var mm = today.getMonth() + 1;
            var yyyy = today.getFullYear();

            if(dd < 10)
            {
                dd= '0' + dd;
            }
            if(mm < 10)
            {
                mm = '0' + mm;
            }
            today = yyyy + '-' + mm + '-' + dd;
            document.getElementById("startDate").setAttribute("max", today);
            document.getElementById("endDate").setAttribute("max", today);
            document.getElementById("endDate").setAttribute("value", today);
        }

        //format parameter values that is required by the script calling DB.
        // params: javascript object containing name : value pairs.
        function formatParams(params)
        {
            return "?" + Object.keys(params).map(function(key)
            {
                return key+"="+encodeURIComponent(params[key])
            }).join("&")
        }
       //]]>
    </script>
</div>
</body>
</html>