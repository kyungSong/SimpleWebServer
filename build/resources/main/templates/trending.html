<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>연관 검색어/실시간 검색어</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <script src="https://cdn.anychart.com/js/7.14.3/anychart-bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdn.anychart.com/css/7.14.3/anychart-ui.min.css" />
    <link rel="stylesheet" href="https://cdn.anychart.com/fonts/2.7.3/anychart.css" />
    <style>
body {margin:0;}

.navbar {
  overflow: hidden;
  background-color: #333;
  position: fixed;
  top: 0;
  width: 100%;
}

.navbar a {
  float: left;
  display: block;
  color: #f2f2f2;
  text-align: center;
  padding: 14px 16px;
  text-decoration: none;
  font-size: 17px;
}

.main {
  padding: 16px;
  margin-top: 30px;
  height: 1500px;
}

#container{
    width: 100%;
    height: 100%;
    margin: auto;
    padding: 0;
}

#related {
    width: 50%;
    float: left;
    height: 50%;
}

#rising {
    width: 50%;
    float: right;
    height: 50%;
}

#clear {
    clear: both;
}
</style>
</head>
<body onload="dateSetter()">
<div class="navbar">
    <a href="/">Home</a>
    <a href="/trending.html">Trending Words</a>
    <a href="#contact">Contact</a>
    <a href="#about">About</a>
</div>

<div class="main">

    <h1><p th:text ="'Hello, ' + ${name} + '!'" /></h1>

    <form id="searchParam" onsubmit="return runGoogleTrends();">
        검색어: <input type="text" name="searchTerm" value="게임" /><br />
        기간: <input type="date" name="startDate" id="startDate" value="2015-03-14" min="2000-01-01" max="2000-13-13"/> 부터 <input type="date" name="endDate" id="endDate" value="2017-01-01" min="2000-01-02" max="2000-13-13"/>까지<br />
        <Input type="submit" value="Submit" />
    </form>

    <div id="container">
        <div id="related"></div>
        <div id="rising"></div>
        <div id="clear"></div>
    </div>

    <script>//<![CDATA[
    // run google trends API
    function runGoogleTrends()
    {
        preloader = anychart.ui.preloader();

        preloader.render(document.getElementById("container"));

        preloader.visible(true);
        var params = {
            searchTerm : '"' + document.getElementById("searchParam").elements[0].value + '"',
            startDate : document.getElementById("searchParam").elements[1].value,
            endDate : document.getElementById("searchParam").elements[2].value
        }
        var url = "google_trends" + formatParams(params);
        var EorK = isEnglish(document.getElementById("searchParam").elements[0].value);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function() {
            if (this.readyState == 4 && this.status == 200) {
                document.getElementById("related").innerHTML = "";
                document.getElementById("rising").innerHTML = "";
                formatDataForChart(this.responseText, EorK);

            }
        };
        xhttp.open("GET", url, true);
        xhttp.send();
        return false;
    }

    //format related queries data received from runGoogleTrends function.
    function formatDataForChart(data, EorK)
    {
        var splitData = data.split("splitHereForList");
        splitData[0] = JSON.parse(splitData[0]);
        splitData[1] = JSON.parse(splitData[1]);

        var chartData = [];
        for (var key in splitData)
        {
            if (splitData.hasOwnProperty(key))
            {
                var tempHolder = [];
                for (var key2 in splitData[key])
                {
                    if (splitData[key].hasOwnProperty(key2))
                    {
                        tempHolder.push({"x": splitData[key][key2].query, "value": splitData[key][key2].value});
                    }
                }
                chartData.push(tempHolder);
            }
        }

        runAnychart(chartData, EorK);
    }

    //create tag cloud using anychart.
    //data is javascript object that contains data to be used as tag cloud compoment
    //EorK is boolean that determines if search term is in English or Korean (true if English, false if not i.e. "not English" is treated as Korean).
    function runAnychart(data, EorK) {
    var related = data[0];
    var rising = data[1];
    anychart.onDocumentReady(function() {
        // Creates Tag Cloud chart.
        relatedChart = anychart.tagCloud(related);
        risingChart = anychart.tagCloud(rising);
        if (EorK)
        {
            relatedChart.title("Users who searched the term: " + '"' + document.getElementById("searchParam").elements[0].value + '"' + " also searched: ");
            risingChart.title("Users who searched the term: " + '"' + document.getElementById("searchParam").elements[0].value + '"' + " are searching these terms in increased frequency: ");
        } else {
            relatedChart.title('"' + document.getElementById("searchParam").elements[0].value + '"' + "을(를) 검색한 사람들이 많이 찾은 검색어");
            risingChart.title('"' + document.getElementById("searchParam").elements[0].value + '"' + "을(를) 검색한 사람들이 검색한 빈도수가 높은 검색어");

        }

        relatedChart.container("related");
        risingChart.container("rising");

        relatedChart.draw();
        risingChart.draw();

        preloader.visible(false);
    });
    }

    function unicodeParse(searchTerm)
    {

    }

    //checks if search term is in "English" (i.e. alphanumeric)
    function isEnglish(searchTerm)
    {
        var len = searchTerm.length;
        var letterCode;

        for (var i = 0; i < len; i++)
        {
            letterCode = searchTerm.charCodeAt(i);
            if (!(letterCode > 47 && letterCode < 58) &&
                !(letterCode > 64 && letterCode < 91) &&
                !(letterCode > 96 && letterCode < 123))
            {
                return false;
            }
        }
        return true;
    };


    //format date and set maximum for the two date fields
    function dateSetter()
    {
        var today = new Date();
        var dd = today.getDate();
        var mm = today.getMonth() + 1;
        var yyyy = today.getFullYear();

        if(dd < 10)
        {
            dd= '0' + dd;
        }
        if(mm < 10)
        {
            mm = '0' + mm;
        }
        today = yyyy + '-' + mm + '-' + dd;
        document.getElementById("startDate").setAttribute("max", today);
        document.getElementById("endDate").setAttribute("max", today);
    }

    //format parameter values that is required by google trends API.
    // params: javascript object containing name : value pairs.
    function formatParams(params)
    {
        return "?" + Object.keys(params).map(function(key)
        {
            return key+"="+encodeURIComponent(params[key])
        }).join("&")
    }
        //]]>
     </script>
</div>

</body>
</html>